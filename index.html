<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Bordo Unificado Cosmos</title>
    
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#8B5CF6" />

    <!-- CDNs (Consolidated) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/3.6.0/locale/pt-BR.min.js" integrity="sha512-rZ8VOUgoR7U3X3z09kqX0vaJ8cMhJ7j3REKHx34kF3oAgCR2vVdSwyXFpXg4DCH91iHptQ3e51Z4BStx2kU/wA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- ✨ Biblioteca de celebração adicionada! ✨ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <!-- Fonts (Consolidated) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌠</text></svg>">

    <style>
        /* --- STYLES FOR PATRIMONIO BUBBLE --- */
        #page-patrimonio .patrimonio-info-bubble-wrapper {
            position: fixed;
            top: 85px;      
            right: 20px;     
            z-index: 950;
            pointer-events: none;
            display: flex; /* Changed from none to flex to be visible by default on this page */
        }

        #page-patrimonio .patrimonio-info-bubble-container {
            position: relative;
            background: linear-gradient(145deg, rgba(52, 211, 153, 0.25), rgba(10, 177, 128, 0.2)); /* Greenish theme */
            border: 1px solid rgba(74, 222, 128, 0.4);
            color: #E0E0E0;
            border-radius: 50px;
            box-shadow: 0 0 20px rgba(52, 211, 153, 0.3), inset 0 0 10px rgba(52, 211, 153, 0.1);
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            cursor: pointer;
            overflow: hidden;
            min-height: calc(1.1em + 1.4rem); /* For the main content line */
            max-height: calc(1.1em + 1.4rem);
            transition: max-height 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), border-radius 0.4s ease-in-out,
                        box-shadow 0.4s ease, background 0.4s ease;
            pointer-events: auto; /* Make the bubble interactive */
            width: fit-content;
            padding: 0;
        }

        #page-patrimonio .patrimonio-info-bubble-container:hover {
            max-height: 500px; /* Adjust if more content */
            border-radius: 20px;
            background: linear-gradient(145deg, rgba(52, 211, 153, 0.4), rgba(10, 177, 128, 0.35));
            box-shadow: 0 10px 35px rgba(52, 211, 153, 0.5), inset 0 0 15px rgba(74, 222, 128, 0.15);
        }

        #page-patrimonio .patrimonio-info-bubble-container .bubble-main-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 0.7rem 1.5rem;
            flex-shrink: 0;
            line-height: 1.1em;
        }

        #page-patrimonio .patrimonio-info-bubble-container .bubble-main-content span:first-child {
            font-weight: 500;
            font-size: 0.9em;
            color: #A7F3D0; /* Lighter green for text */
        }

        #page-patrimonio #patrimonioBubbleUltimoValor {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 8px rgba(74, 222, 128, 0.7);
        }

        #page-patrimonio .patrimonio-info-bubble-container .bubble-details-content {
            width: 100%;
            padding: 1rem 1.5rem 0.8rem 1.5rem;
            margin-top: 0.6rem;
            border-top: 1px solid rgba(74, 222, 128, 0.3);
            opacity: 0;
            transform: translateY(-8px) scaleY(0.98);
            transform-origin: top center;
            transition: opacity 0.4s ease-out 0.1s, transform 0.4s ease-out 0.1s;
            pointer-events: none;
        }

        #page-patrimonio .patrimonio-info-bubble-container:hover .bubble-details-content {
            opacity: 1;
            transform: translateY(0) scaleY(1);
            pointer-events: auto;
        }

        #page-patrimonio .patrimonio-info-bubble-container .bubble-details-content p {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.7rem;
            font-size: 0.85em;
        }

        #page-patrimonio .patrimonio-info-bubble-container .bubble-details-content p:last-child {
            margin-bottom: 0;
        }

        #page-patrimonio .patrimonio-info-bubble-container .bubble-details-content span:first-child {
            color: #D1D5DB;
            margin-right: 10px;
            flex-shrink: 0;
        }

        #page-patrimonio .patrimonio-info-bubble-container .bubble-details-content span:last-child {
            font-weight: 600;
            text-align: right;
            word-break: break-all;
        }
        #page-patrimonio #patrimonioBubbleMaiorValor { color: var(--cosmos-positive); }
        #page-patrimonio #patrimonioBubbleDiferencaPico { color: var(--cosmos-warning); }
        #page-patrimonio #patrimonioBubbleFlutuacaoRecente.positivo { color: var(--cosmos-positive); }
        #page-patrimonio #patrimonioBubbleFlutuacaoRecente.negativo { color: var(--cosmos-negative); }
        #page-patrimonio #patrimonioBubbleFlutuacaoRecente.neutro { color: var(--cosmos-text-secondary); }

        /* --- GLOBAL RESET & BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        /* --- GLOBAL CSS VARIABLES --- */
        :root {
            --font-body: 'Inter', sans-serif;
            --font-title: 'Orbitron', sans-serif;
            --cosmos-bg: #0D1117;
            --cosmos-text-primary: #E0E0E0;
            --cosmos-text-secondary: #A0AEC0;
            --cosmos-card-bg: rgba(29, 29, 40, 0.88);
            --cosmos-border: rgba(124, 58, 237, 0.40);
            --cosmos-border-hover: rgba(167, 139, 250, 0.7);
            --cosmos-shadow-strong: rgba(0, 0, 0, 0.55);
            --cosmos-shadow-soft-glow: rgba(167, 139, 250, 0.12);
            --cosmos-purple-primary: #A78BFA;
            --cosmos-purple-secondary: #C4B5FD;
            --cosmos-purple-dark: #8B5CF6;
            --cosmos-blue-accent: #60A5FA;
            --cosmos-pink-accent: #EC4899;
            --cosmos-cyan-accent: #6AF2F0;
            --cosmos-cyan-glow: rgba(106, 242, 240, 0.35);
            --cosmos-positive: #34D399;
            --cosmos-negative: #F87171;
            --cosmos-warning: #FBBF24;
            --cosmos-input-bg: rgba(13, 17, 23, 0.92);
            --cosmos-input-border: rgba(124, 58, 237, 0.45);
            --cosmos-input-focus-border: var(--cosmos-purple-primary);
            --cosmos-input-focus-shadow: rgba(167, 139, 250, 0.45);
            --cosmos-button-edit-bg: #F59E0B;
            --cosmos-button-save-bg: var(--cosmos-positive);
            --cosmos-button-cancel-bg: #6B7280;
            --cosmos-button-delete-border: var(--cosmos-pink-accent);
            --cosmos-button-delete-text: var(--cosmos-pink-accent);
            --cosmos-button-delete-hover-bg: rgba(236, 72, 153, 0.18);
            --cosmos-button-delete-hover-text: #fda4af;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.6;
            background-color: var(--cosmos-bg);
            color: var(--cosmos-text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            padding-top: 70px; 
        }
        
        #starry-sky-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background-image:
                radial-gradient(ellipse at center, rgba(30, 27, 75, 0.12) 0%, transparent 70%),
                radial-gradient(ellipse at top left, rgba(80, 30, 70, 0.1) 0%, transparent 60%),
                radial-gradient(ellipse at bottom right, rgba(20, 50, 90, 0.1) 0%, transparent 60%),
                radial-gradient(circle at 10% 20%, rgba(210, 210, 255, 0.6) 0.5px, transparent 1px),
                radial-gradient(circle at 30% 50%, rgba(190, 210, 255, 0.5) 0.5px, transparent 1px),
                radial-gradient(circle at 70% 30%, rgba(220, 200, 255, 0.7) 0.5px, transparent 1px),
                radial-gradient(circle at 90% 60%, rgba(200, 200, 255, 0.4) 0.5px, transparent 1px),
                radial-gradient(circle at 50% 80%, rgba(220, 200, 255, 0.6) 0.5px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 100% 100%, 50px 50px, 70px 70px, 60px 60px, 80px 80px, 90px 90px;
            opacity: 0;
            animation: subtleStarShine 35s infinite alternate ease-in-out, fadeInBg 3s 0.5s ease-out forwards;
            pointer-events: none; will-change: opacity, transform;
        }
        @keyframes subtleStarShine { 0% { opacity: 0.6; transform: scale(1.005) rotate(0.05deg); } 100% { opacity: 0.9; transform: scale(1) rotate(-0.05deg); } }
        @keyframes fadeInBg { to { opacity: 0.85; } }

        /* --- NAVIGATION --- */
        #main-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(10px) saturate(150%);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: center; 
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            border-bottom: 1px solid var(--cosmos-border);
        }
        #main-nav a {
            font-family: var(--font-title);
            font-size: 0.9em;
            font-weight: 500;
            color: var(--cosmos-text-secondary);
            background-color: transparent;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-decoration: none; /* Remove underline from links */
        }
        #main-nav a:hover {
            color: var(--cosmos-text-primary);
            background-color: rgba(167, 139, 250, 0.1);
            border-color: var(--cosmos-purple-primary);
            transform: translateY(-2px);
        }
        #main-nav a.active {
            color: var(--cosmos-cyan-accent);
            background-color: rgba(106, 242, 240, 0.15);
            border-color: var(--cosmos-cyan-accent);
            box-shadow: 0 0 10px var(--cosmos-cyan-glow);
            font-weight: 700;
        }
        
        /* --- GLOBAL UTILITIES --- */
        .loading-spinner-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(13, 17, 23, 0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .loading-spinner-overlay.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .spinner {
            width: 60px; height: 60px; border: 5px solid rgba(106, 242, 240, 0.2);
            border-top-color: var(--cosmos-cyan-accent); border-radius: 50%;
            animation: spin 1s linear infinite, pulseSpinnerGlow 2s infinite alternate;
            box-shadow: 0 0 15px var(--cosmos-cyan-glow);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulseSpinnerGlow {
            from { box-shadow: 0 0 10px rgba(106, 242, 240, 0.3); }
            to { box-shadow: 0 0 25px rgba(106, 242, 240, 0.6); }
        }

        #notification-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 3000;
            display: flex; flex-direction: column-reverse; gap: 10px;
        }
        .notification-popup {
            font-family: var(--font-body); background-color: var(--cosmos-card-bg);
            color: var(--cosmos-text-primary); padding: 12px 18px; border-radius: 0.5rem;
            border-left: 5px solid var(--cosmos-blue-accent);
            box-shadow: 0 5px 20px var(--cosmos-shadow-strong), 0 0 12px var(--cosmos-shadow-soft-glow);
            opacity: 0; transform: translateX(120%);
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            min-width: 280px; max-width: 380px; font-size: 0.9em; line-height: 1.45;
            display: flex; align-items: center; cursor: pointer;
        }
        .notification-popup.show { opacity: 1; transform: translateX(0); }
        .notification-popup.success { border-left-color: var(--cosmos-positive); }
        .notification-popup.error { border-left-color: var(--cosmos-negative); }
        .notification-popup.warning { border-left-color: var(--cosmos-warning); }
        .notification-popup.info { border-left-color: var(--cosmos-blue-accent); }
        .notification-popup .icon { margin-right: 12px; font-size: 1.3em; line-height: 1; }
        .notification-popup.success .icon { color: var(--cosmos-positive); }
        .notification-popup.error .icon { color: var(--cosmos-negative); }
        .notification-popup.warning .icon { color: var(--cosmos-warning); }
        .notification-popup.info .icon { color: var(--cosmos-blue-accent); }
        
        /* --- ✨ STYLES FOR VERTICAL PROGRESS BAR ✨ --- */
        #vertical-progress-container {
            position: fixed;
            left: 20px;
            bottom: 20px;
            z-index: 900; /* Abaixo de notificações e modais */
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--cosmos-text-secondary);
            pointer-events: none; /* Não interfere com cliques */
            animation: fadeInVerticalBar 1.5s 1s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeInVerticalBar {
            to { opacity: 1; }
        }

        #vertical-progress-container .v-progress-label {
            font-family: var(--font-title);
            font-size: 0.8em;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }

        #vertical-progress-container .v-progress-bar-track {
            width: 12px;
            height: 250px;
            background-color: var(--cosmos-input-bg);
            border: 1px solid var(--cosmos-input-border);
            border-radius: 10px;
            position: relative; /* Contexto para a barra de preenchimento */
            overflow: hidden; /* Garante que a barra de preenchimento respeite o border-radius */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4), 0 0 10px var(--cosmos-shadow-soft-glow);
        }

        #vertical-progress-container .v-progress-bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 0%; /* Começa vazia, será controlada por JS */
            background-image: linear-gradient(0deg, var(--cosmos-positive), var(--cosmos-cyan-accent)); /* Gradiente de baixo para cima */
            border-radius: 10px;
            transition: height 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), background-image 0.5s ease;
            box-shadow: 0 0 12px var(--cosmos-cyan-glow);
        }

        #vertical-progress-container .v-progress-percentage {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            color: var(--cosmos-text-primary);
            font-size: 1em;
            margin-top: 8px;
            text-shadow: 0 0 8px var(--cosmos-cyan-glow);
        }

        /* Ocultar em telas menores para não poluir a interface */
        @media (max-width: 768px) {
            #vertical-progress-container {
                display: none;
            }
        }

        .page-view { padding: 2rem; }
        .container { max-width: 1200px; margin: 0 auto; width: 100%; } 
        .hidden { display: none !important; }

        /* --- STYLES FOR PATRIMONIO PAGE (Scoped to #page-patrimonio) --- */
        #page-patrimonio header { text-align: center; margin-bottom: 2.5rem; animation: fadeInHeaderPatrimonio 1s ease-out; }
        @keyframes fadeInHeaderPatrimonio { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        #page-patrimonio header h1 {
            font-family: var(--font-title);
            color: var(--cosmos-text-primary); font-weight: 700; font-size: 2.5em;
            text-shadow: 0 0 12px var(--cosmos-cyan-glow), 0 0 8px var(--cosmos-purple-primary), 0 0 20px var(--cosmos-purple-dark); 
            background: linear-gradient(135deg, var(--cosmos-cyan-accent), var(--cosmos-purple-secondary), var(--cosmos-purple-dark), var(--cosmos-pink-accent));
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; text-fill-color: transparent;
            background-size: 300% auto; 
            animation: textGradientShinePatrimonio 6s linear infinite alternate, cosmicPulsePatrimonio 4s infinite ease-in-out;
        }
        @keyframes textGradientShinePatrimonio { to { background-position: 300% center; } }
        @keyframes cosmicPulsePatrimonio {
            0%, 100% { filter: brightness(1); transform: scale(1); }
            50% { filter: brightness(1.2); transform: scale(1.02); }
        }
        #page-patrimonio .secao {
            background-color: var(--cosmos-card-bg);
            backdrop-filter: blur(12px) saturate(130%); 
            border: 1px solid var(--cosmos-border);
            padding: 1.8rem 2rem; border-radius: 0.85rem;
            box-shadow: 0 8px 30px var(--cosmos-shadow-strong), inset 0 0 10px rgba(13,17,23,0.5), 0 0 10px var(--cosmos-shadow-soft-glow); 
            margin-bottom: 2.2rem;
            animation: popInSmoothPatrimonio 0.7s cubic-bezier(0.25, 0.8, 0.25, 1) backwards; 
            will-change: opacity, transform, box-shadow;
        }
        #page-patrimonio .secao:nth-child(1) { animation-delay: 0.15s; }
        #page-patrimonio .secao:nth-child(2) { animation-delay: 0.25s; }
        #page-patrimonio .secao:nth-child(3) { animation-delay: 0.35s; }
        #page-patrimonio .secao:nth-child(4) { animation-delay: 0.45s; }
        @keyframes popInSmoothPatrimonio { 0% { opacity: 0; transform: scale(0.95) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        #page-patrimonio .secao:hover {
             transform: translateY(-5px) scale(1.005); 
             box-shadow: 0 14px 40px var(--cosmos-shadow-strong), 0 0 25px var(--cosmos-purple-primary), 0 0 10px var(--cosmos-cyan-glow), inset 0 0 12px rgba(13,17,23,0.6);
             border-color: var(--cosmos-border-hover);
        }
        #page-patrimonio .secao h2 {
            font-family: var(--font-title);
            color: var(--cosmos-text-primary); margin-bottom: 1.5rem; text-align: left; font-weight: 500; font-size: 1.6em;
            position: relative; padding-bottom: 0.6rem; 
            border-bottom: 2px solid transparent;
        }
        #page-patrimonio .secao h2::after { 
            content: ''; position: absolute; bottom: -2px; left: 0;
            width: 0%; height: 2px; 
            background: linear-gradient(90deg, var(--cosmos-cyan-accent), var(--cosmos-pink-accent), var(--cosmos-purple-primary));
            border-radius: 2px;
            transition: width 0.5s ease-in-out 0.1s; 
            box-shadow: 0 0 8px var(--cosmos-cyan-accent);
        }
        #page-patrimonio .secao:hover h2::after { width: 75%; } 
        #page-patrimonio .cards-container { display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: space-around; margin-bottom: 1rem; }
        #page-patrimonio .card {
            background: linear-gradient(145deg, rgba(35,40,60,0.92), rgba(25,30,45,0.97)); 
            border: 1px solid var(--cosmos-border);
            padding: 1.2rem 1.5rem; border-radius: 0.6rem;
            flex: 1 1 250px; min-width: 220px;
            box-shadow: 0 4px 18px var(--cosmos-shadow-strong), 0 0 8px var(--cosmos-shadow-soft-glow), inset 0 1px 2px rgba(13,17,23,0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative; overflow: hidden; 
        }
        #page-patrimonio .card::before { 
            content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(106, 242, 240, 0.08), transparent);
            transition: left 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #page-patrimonio .card:hover::before { left: 100%; }
        #page-patrimonio .card:hover {
            transform: translateY(-6px) scale(1.025);
            border-color: var(--cosmos-cyan-accent);
            box-shadow: 0 10px 30px var(--cosmos-shadow-strong), 0 0 20px var(--cosmos-cyan-glow), inset 0 1px 3px rgba(13,17,23,0.5);
        }
        #page-patrimonio .card h3 { font-family: var(--font-title); font-size: 1.0em; color: var(--cosmos-purple-secondary); font-weight: 500; margin-bottom: 0.5rem; }
        #page-patrimonio .card p { margin: 0.3rem 0; font-size: 1.3em; font-weight: 700; color: var(--cosmos-text-primary); }
        #page-patrimonio .card .subtext { font-size: 0.8em; font-weight: 400; color: var(--cosmos-text-secondary); opacity: 0.9; }
        #page-patrimonio .card .valor-card {}
        #page-patrimonio .card .positivo { color: var(--cosmos-positive) !important; text-shadow: 0 0 6px var(--cosmos-positive); animation: pulsePositivePatrimonio 2s infinite alternate; }
        #page-patrimonio .card .negativo { color: var(--cosmos-negative) !important; text-shadow: 0 0 6px var(--cosmos-negative); animation: pulseNegativePatrimonio 2s infinite alternate; }
        @keyframes pulsePositivePatrimonio { from { opacity: 0.8; filter: brightness(0.9); } to { opacity: 1; filter: brightness(1.1); } }
        @keyframes pulseNegativePatrimonio { from { opacity: 0.8; filter: brightness(0.9); } to { opacity: 1; filter: brightness(1.1); } }
        #page-patrimonio .card .mini-btn {
            background: rgba(106, 242, 240, 0.1); border: 1px solid rgba(106, 242, 240, 0.3);
            color: var(--cosmos-cyan-accent); padding: 0.2rem 0.5rem; border-radius: 0.25rem;
            font-size: 0.8em; cursor: pointer; margin-left: 0.5rem; transition: all 0.2s ease;
        }
        #page-patrimonio .card .mini-btn:hover { background: rgba(106, 242, 240, 0.2); border-color: var(--cosmos-cyan-accent); box-shadow: 0 0 5px var(--cosmos-cyan-glow); }
        #page-patrimonio .progress-bar-meta-bg { width: 100%; height: 10px; background-color: rgba(13,17,23,0.7); border-radius: 5px; margin-top: 0.5rem; overflow: hidden; border: 1px solid var(--cosmos-input-border); }
        #page-patrimonio .progress-bar-meta-fill { height: 100%; background-image: linear-gradient(90deg, var(--cosmos-positive), var(--cosmos-cyan-accent)); transition: width 0.5s ease-out; border-radius: 5px; box-shadow: 0 0 8px var(--cosmos-cyan-glow); }
        #page-patrimonio #patrimonioChartContainer { padding: 1.5rem; background-color: var(--cosmos-card-bg); border-radius: 0.85rem; border: 1px solid var(--cosmos-border); box-shadow: 0 8px 30px var(--cosmos-shadow-strong), inset 0 0 8px var(--cosmos-shadow-soft-glow); height: 400px; }
        #page-patrimonio .table-controls { display: flex; justify-content: flex-end; margin-bottom: 1rem; gap: 0.8rem; }
        #page-patrimonio table { width: 100%; border-collapse: separate; border-spacing: 0; background-color: rgba(15, 18, 30, 0.85); border-radius: 0.75rem; overflow: hidden; box-shadow: 0 5px 20px var(--cosmos-shadow-strong); border: 1px solid var(--cosmos-border); }
        #page-patrimonio th { background-color: rgba(20, 25, 45, 0.9); color: var(--cosmos-cyan-accent); font-weight: 600; padding: 0.8rem 1rem; font-family: var(--font-title); border-bottom: 2px solid var(--cosmos-cyan-accent); white-space: nowrap; font-size: 0.95em; text-align: left; text-shadow: 0 0 4px var(--cosmos-cyan-accent); }
        #page-patrimonio td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--cosmos-input-border); vertical-align: middle; font-size: 0.9em; color: var(--cosmos-text-secondary); transition: background-color 0.2s ease, color 0.2s ease; }
        #page-patrimonio tbody tr:last-child td { border-bottom: none; }
        #page-patrimonio tbody tr:nth-child(even) { background-color: rgba(20, 25, 45, 0.5); }
        #page-patrimonio tbody tr:hover { background-color: rgba(106, 242, 240, 0.07); color: var(--cosmos-text-primary); }
        #page-patrimonio tbody tr:hover td { color: var(--cosmos-cyan-accent); }
        #page-patrimonio .positivo { color: var(--cosmos-positive) !important; font-weight: 600; text-shadow: 0 0 4px var(--cosmos-positive); }
        #page-patrimonio .negativo { color: var(--cosmos-negative) !important; font-weight: 600; text-shadow: 0 0 4px var(--cosmos-negative); }
        #page-patrimonio #addEntryForm { margin-top: 1.5rem; padding: 1.5rem; background-color: rgba(20,25,40,0.7); border-radius: 0.75rem; border: 1px solid var(--cosmos-border); box-shadow: 0 0 10px var(--cosmos-shadow-soft-glow); }
        #page-patrimonio #addEntryForm h3 { font-family: var(--font-title); color: var(--cosmos-purple-secondary); font-weight: 500; font-size: 1.3em; margin-bottom: 1rem; }
        #page-patrimonio #addEntryForm input, #page-patrimonio #addEntryForm select { padding: 0.7rem 0.9rem; margin-right: 0.8rem; margin-bottom: 0.8rem; border: 1px solid var(--cosmos-input-border); border-radius: 0.375rem; background-color: var(--cosmos-input-bg); color: var(--cosmos-text-primary); font-family: var(--font-body); font-size: 0.95em; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        #page-patrimonio #addEntryForm input::placeholder { color: var(--cosmos-text-secondary); opacity: 0.7; }
        #page-patrimonio #addEntryForm input:focus, #page-patrimonio #addEntryForm select:focus { outline: none; border-color: var(--cosmos-input-focus-border); box-shadow: 0 0 0 3px var(--cosmos-input-focus-shadow), 0 0 8px var(--cosmos-cyan-glow); }
        #page-patrimonio .table-controls button, #page-patrimonio #addEntryForm button, #page-patrimonio .row-delete-btn {
            border: none; padding: 0.7rem 1.3rem;  border-radius: 0.375rem;
            cursor: pointer; font-weight: 500; font-size: 0.9em;
            transition: all 0.25s ease-out; 
            color: #fff; position: relative; overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.25);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05); 
        }
        #page-patrimonio .table-controls button:hover, #page-patrimonio #addEntryForm button:hover, #page-patrimonio .row-delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08), 0 0 10px var(--cosmos-cyan-glow); 
        }
        #page-patrimonio .table-controls button::before, #page-patrimonio #addEntryForm button::before, #page-patrimonio .row-delete-btn::before { 
             content: ""; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transform: translate(-50%, -50%); border-radius: 50%; opacity: 0;
            transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease;
        }
        #page-patrimonio .table-controls button:hover::before, #page-patrimonio #addEntryForm button:hover::before, #page-patrimonio .row-delete-btn:hover::before {
            width: 200%; height: 200%; opacity: 1;
        }
        #page-patrimonio .table-controls button:active, #page-patrimonio #addEntryForm button:active, #page-patrimonio .row-delete-btn:active { transform: translateY(0px) scale(0.98); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        #page-patrimonio #toggleEditModeBtn { background-color: var(--cosmos-button-edit-bg); }
        #page-patrimonio #toggleEditModeBtn::after { content: ' 🛠️'; } 
        #page-patrimonio #saveAllBtn, #page-patrimonio #addEntryForm .save-btn { background-image: linear-gradient(135deg, var(--cosmos-button-save-bg) 0%, #10B981 100%); }
        #page-patrimonio #saveAllBtn::after { content: ' 💾'; }
        #page-patrimonio #addEntryForm .save-btn::after { content: ' ✨'; }
        #page-patrimonio #cancelEditBtn { background-color: var(--cosmos-button-cancel-bg); }
        #page-patrimonio #cancelEditBtn::after { content: ' ↩️'; }
        #page-patrimonio .row-delete-btn { background-color: transparent; border: 1px solid var(--cosmos-button-delete-border); color: var(--cosmos-button-delete-text); padding: 0.4rem 0.8rem; font-size: 0.85em; }
        #page-patrimonio .row-delete-btn::after { content: ' 🗑️'; margin-left: 4px;}
        #page-patrimonio .row-delete-btn:hover { background-color: var(--cosmos-button-delete-hover-bg); color: var(--cosmos-button-delete-hover-text); border-color: var(--cosmos-button-delete-hover-text); }
        #page-patrimonio td input[type="text"], #page-patrimonio td input[type="number"], #page-patrimonio td input[type="date"] { width: 100%; padding: 0.5rem; background-color: var(--cosmos-input-bg); color: var(--cosmos-text-primary); border: 1px solid var(--cosmos-input-border); border-radius: 0.25rem;}
        #page-patrimonio td input:focus { outline: none; border-color: var(--cosmos-input-focus-border); box-shadow: 0 0 0 2px var(--cosmos-input-focus-shadow); }
        #page-patrimonio .editing-row td:last-child { text-align: center; }
        #page-patrimonio #themeToggle { display: none; }
        #page-patrimonio .resumo-agregado h2 { text-align: center; }
        #page-patrimonio .resumo-controles { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        #page-patrimonio .resumo-controles label { font-size: 0.9em; color: var(--cosmos-text-secondary); }
        #page-patrimonio .resumo-controles select { padding: 0.5rem 0.8rem; background-color: var(--cosmos-input-bg); color: var(--cosmos-text-primary); border: 1px solid var(--cosmos-input-border); border-radius: 0.375rem; font-family: var(--font-body); min-width: 120px; }
        #page-patrimonio #resumoAgregadoContainer { margin-top: 1rem; text-align: center; }
        #page-patrimonio .placeholder-resumo { color: var(--cosmos-text-secondary); font-style: italic; }
        #page-patrimonio .resumo-item { background-color: rgba(20,25,40,0.7); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.8rem; border: 1px solid var(--cosmos-border); text-align: left; }
        #page-patrimonio .resumo-item h4 { font-family: var(--font-title); color: var(--cosmos-purple-secondary); margin-bottom: 0.5rem; font-size: 1.1em; }
        #page-patrimonio .resumo-item p { font-size: 0.95em; margin-bottom: 0.3rem; color: var(--cosmos-text-secondary); }
        #page-patrimonio .resumo-item p strong { color: var(--cosmos-text-primary); margin-left: 0.3rem; }
        #page-patrimonio .resumo-item .positivo { color: var(--cosmos-positive) !important; }
        #page-patrimonio .resumo-item .negativo { color: var(--cosmos-negative) !important; }
        @media (max-width: 600px) {
            #page-patrimonio #notification-container { right: 10px; bottom: 10px; left: 10px; align-items: stretch; }
            #page-patrimonio .notification-popup { min-width: unset; width: 100%; }
        }

        /* --- ✨ STYLES FOR META ACHIEVEMENT MODAL ✨ --- */
        .meta-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 17, 23, 0.7);
            backdrop-filter: blur(8px) brightness(0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .meta-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .meta-popup-container {
            background: linear-gradient(160deg, var(--cosmos-card-bg) 0%, rgba(20,25,45,0.95) 100%);
            border: 1px solid var(--cosmos-cyan-accent);
            border-radius: 1rem;
            padding: 2.5rem 3rem;
            box-shadow: 0 0 25px var(--cosmos-cyan-glow), 0 0 45px var(--cosmos-purple-primary), inset 0 0 15px rgba(106, 242, 240, 0.2);
            text-align: center;
            max-width: 550px;
            width: 90%;
            transform: scale(0.8) translateY(20px);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) 0.1s, opacity 0.5s ease 0.1s;
            position: relative;
            z-index: 4001; /* Acima do overlay */
        }

        .meta-modal-overlay.visible .meta-popup-container {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .meta-popup-container h1 {
            font-family: var(--font-title);
            font-size: 2.2em;
            font-weight: 900;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--cosmos-cyan-accent), #fff, var(--cosmos-warning), var(--cosmos-positive));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-fill-color: transparent;
            animation: textGradientShinePatrimonio 5s linear infinite, cosmicPulsePatrimonio 3s infinite ease-in-out;
            text-shadow: 0 0 15px var(--cosmos-cyan-glow);
        }

        .meta-popup-container .celebracao-subtitulo {
            font-size: 1.1em;
            color: var(--cosmos-text-secondary);
            margin-bottom: 2rem;
        }
        .meta-popup-container .celebracao-subtitulo strong {
            color: var(--cosmos-positive);
            font-weight: 700;
        }

        .novo-desafio-box {
            background: rgba(13,17,23,0.5);
            border: 1px solid var(--cosmos-input-border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .novo-desafio-box h2 {
            font-family: var(--font-title);
            font-size: 1.4em;
            color: var(--cosmos-purple-secondary);
            margin-bottom: 0.5rem;
        }
        .novo-desafio-box p {
            font-size: 1.1em;
            color: var(--cosmos-text-primary);
            margin-bottom: 1.5rem;
        }
        .novo-desafio-box strong {
            color: var(--cosmos-warning);
            font-size: 1.2em;
            font-weight: 700;
            text-shadow: 0 0 8px var(--cosmos-warning);
        }

        .meta-popup-container .modal-btn-aceitar,
        .meta-popup-container .modal-btn-fechar {
            border: none;
            padding: 0.8rem 1.8rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            font-family: var(--font-title);
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .meta-popup-container .modal-btn-aceitar {
            background-image: linear-gradient(135deg, var(--cosmos-button-save-bg) 0%, var(--cosmos-cyan-accent) 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4);
        }
        .meta-popup-container .modal-btn-aceitar:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(106, 242, 240, 0.5);
        }

        .meta-popup-container .modal-btn-fechar {
            background: transparent;
            color: var(--cosmos-text-secondary);
            margin-top: 1rem;
            padding: 0.5rem 1rem;
        }
        .meta-popup-container .modal-btn-fechar:hover {
            color: var(--cosmos-text-primary);
            text-decoration: underline;
        }

    </style>
</head>
<body>
    <!-- ✨ NOVA BARRA DE PROGRESSO VERTICAL ✨ -->
    <div id="vertical-progress-container">
        <span class="v-progress-label">META</span>
        <div class="v-progress-bar-track">
            <div id="verticalProgressBarFill" class="v-progress-bar-fill"></div>
        </div>
        <span id="verticalProgressPercentage" class="v-progress-percentage">0%</span>
    </div>

    <div id="starry-sky-backdrop"></div>
    <div id="loadingOverlay" class="loading-spinner-overlay"><div class="spinner"></div></div>
    <div id="notification-container"></div>

    <nav id="main-nav">
        <a href="index.html" class="active">Patrimônio Estelar</a>
        <a href="emprestimos.html">Empréstimos CosmoFin</a>
        <a href="gastos.html">Gastos Cósmicos</a>
    </nav>

    <main id="page-content-area">
        <!-- Page: Patrimônio (This is the only page content in this file) -->
        <div id="page-patrimonio" class="page-view">

            <div class="patrimonio-info-bubble-wrapper">
                <div class="patrimonio-info-bubble-container">
                    <div class="bubble-main-content">
                        <span>Último Registro:</span>
                        <span id="patrimonioBubbleUltimoValor">R$ 0,00</span>
                    </div>
                    <div class="bubble-details-content">
                        <p><span>Pico Estelar (Maior):</span> <span id="patrimonioBubbleMaiorValor">R$ 0,00</span></p>
                        <p><span>Distância do Pico:</span> <span id="patrimonioBubbleDiferencaPico">R$ 0,00</span></p>
                        <p><span>Flutuação Recente:</span> <span id="patrimonioBubbleFlutuacaoRecente">R$ 0,00</span></p>
                    </div>
                </div>
            </div>

            <div class="container">
                <header>
                    <h1>Painel de Bordo: Patrimônio</h1>
                </header>
                <section class="secao destaques">
                    <h2>Telemetria Financeira</h2>
                    <div class="cards-container">
                        <div class="card" id="cardMetaPatrimonio">
                            <h3>Meta de Patrimônio Galáctico</h3>
                            <p>Meta: <span id="metaValorDisplay">R$ 0,00</span> <button id="definirMetaBtn" class="mini-btn" title="Definir Nova Meta">🎯</button></p>
                            <div class="progress-bar-meta-bg">
                                <div id="progressBarMetaFill" class="progress-bar-meta-fill" style="width: 0%;"></div>
                            </div>
                            <p class="subtext">Progresso: <span id="metaProgressoDisplay">0%</span> (<span id="metaRestanteDisplay" class="valor-card">R$ 0,00</span> restantes)</p>
                        </div>
                        <div class="card" id="cardDiaMaisForte"><h3>Pico de Sinal</h3><p>R$ <span id="diaMaisForteValor" class="valor-card">0.00</span></p><p class="subtext">Em: <span id="diaMaisForteData">-</span></p></div>
                        <div class="card" id="cardMaiorGanho">
                            <h3>Maior Pulso Positivo (Dia)</h3>
                            <p><span id="maiorGanhoValor" class="valor-card">R$ 0,00</span></p>
                            <p class="subtext">Em: <span id="maiorGanhoData">-</span></p>
                        </div>
                        <div class="card" id="cardMaiorPerda">
                            <h3>Maior Dreno de Energia (Dia)</h3>
                            <p><span id="maiorPerdaValor" class="valor-card">R$ 0,00</span></p>
                            <p class="subtext">Em: <span id="maiorPerdaData">-</span></p>
                        </div>
                         <div class="card" id="cardCrescimentoMarco"><h3>Pulso de Março</h3><p><span id="crescimentoMarco" class="valor-card">R$ 0.00</span></p><p class="subtext">(Ciclo: 2025)</p></div>
                        <div class="card" id="cardCrescimentoAbril"><h3>Pulso de Abril</h3><p><span id="crescimentoAbril" class="valor-card">R$ 0.00</span></p><p class="subtext">(Ciclo: 2025)</p></div>
                    </div>
                </section>
                <section class="secao grafico-patrimonio">
                    <h2>Trajetória de Ativos</h2>
                    <div id="patrimonioChartContainer"><canvas id="patrimonioChart"></canvas></div>
                </section>
                <section class="secao resumo-agregado">
                    <h2>Relatório de Flutuações Cósmicas</h2>
                    <div class="resumo-controles">
                        <label for="selectAnoResumo">Ano:</label>
                        <select id="selectAnoResumo"></select>
                        <label for="selectMesResumo">Mês (Opcional):</label>
                        <select id="selectMesResumo">
                            <option value="todos">Todos os Meses</option>
                        </select>
                    </div>
                    <div id="resumoAgregadoContainer">
                        <p class="placeholder-resumo">Selecione o período para análise.</p>
                    </div>
                </section>
                <section class="secao patrimonio-total">
                    <h2>Registros de Navegação Financeira</h2>
                    <div class="table-controls">
                        <button id="toggleEditModeBtn">Interface de Edição</button>
                        <button id="saveAllBtn" class="hidden">Confirmar Dados</button>
                        <button id="cancelEditBtn" class="hidden">Cancelar Edição</button>
                    </div>
                    <div id="addEntryForm">
                        <h3>Novo Registro de Log</h3>
                        <input type="date" id="newEntryDate" required>
                        <input type="text" id="newEntryComentario" placeholder="Descrição da Anomalia/Evento" required>
                        <input type="number" id="newEntryPatrimonio" placeholder="Unidades (Ex: 9000.50)" step="0.01" required>
                        <button id="addEntryBtn" class="save-btn"><span>Registrar</span></button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Data Estelar</th>
                                <th>Log de Evento</th>
                                <th>Saldo (Unidades)</th>
                                <th>Flutuação Diária</th>
                                <th class="edit-action-header hidden">Ejetar Log</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaPatrimonioBody"></tbody>
                    </table>
                </section>
            </div>
        </div>

    </main>

    <!-- ✨ HTML DO MODAL DE CELEBRAÇÃO ✨ -->
    <div id="meta-conquistada-overlay" class="meta-modal-overlay">
        <div id="meta-conquistada-popup" class="meta-popup-container">
            <h1>🚀 CONQUISTA CÓSMICA! 🚀</h1>
            <p class="celebracao-subtitulo">Você atingiu sua meta de <strong id="meta-antiga-display">R$ 50.000,00</strong>! Sua disciplina financeira é de outra galáxia!</p>
            
            <div class="novo-desafio-box">
                <h2>Próxima Missão... se decidir aceitar:</h2>
                <p>Expandir suas fronteiras para um novo patamar de <strong id="nova-meta-proposta-display">R$ 51.000,00</strong>!</p>
                <button id="aceitar-nova-meta-btn" class="modal-btn-aceitar">Aceitar Desafio Estelar! ✨</button>
            </div>
            
            <button id="fechar-meta-modal-btn" class="modal-btn-fechar">Continuar Exploração</button>
        </div>
    </div>


    <script type="module">
        // --- Firebase Configurations and Initializations ---
        const firebaseConfigPatrimonio = {
            apiKey: "AIzaSyBguBmDJQmJ3RCoDrRjNwefZ1pwCPFzAnc",
            authDomain: "patrimonio-338c2.firebaseapp.com",
            databaseURL: "https://patrimonio-338c2-default-rtdb.firebaseio.com",
            projectId: "patrimonio-338c2",
            storageBucket: "patrimonio-338c2.firebasestorage.app",
            messagingSenderId: "552492772905",
            appId: "1:552492772905:web:7352ab0f441f8046a47638",
            measurementId: "G-EMYN0EQYD8"
        };
      
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, remove, onValue, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // Initialize only the Firebase App needed for this page
        const appPatrimonio = initializeApp(firebaseConfigPatrimonio, 'patrimonioApp');
        const databasePatrimonio = getDatabase(appPatrimonio);
      
        // Store common DB functions globally for the script
        window.firebaseDbFunctions = { ref, get, set, update, push, remove, onValue, child };

        const loadingOverlayGlobalEl = document.getElementById('loadingOverlay');
        function showGlobalLoading() { if(loadingOverlayGlobalEl) loadingOverlayGlobalEl.classList.add('visible'); }
        function hideGlobalLoading() { if(loadingOverlayGlobalEl) loadingOverlayGlobalEl.classList.remove('visible'); }

        function showGlobalNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notification-container');
            if (!container) return;
            const notification = document.createElement('div');
            notification.classList.add('notification-popup', type);
            const iconSpan = document.createElement('span');
            iconSpan.classList.add('icon');
            let iconChar = '';
            switch (type) {
                case 'success': iconChar = '✔️'; break;
                case 'error':   iconChar = '❌'; break;
                case 'warning': iconChar = '⚠️'; break;
                case 'info':    iconChar = 'ℹ️'; break;
            }
            iconSpan.textContent = iconChar;
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            notification.appendChild(iconSpan);
            notification.appendChild(messageSpan);
            container.prepend(notification);
            requestAnimationFrame(() => {
                requestAnimationFrame(() => { notification.classList.add('show'); });
            });
            const timerId = setTimeout(() => dismissNotification(), duration);
            const dismissNotification = () => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove(), { once: true });
                setTimeout(() => { if (notification.parentElement) notification.remove(); }, 500);
            };
            notification.addEventListener('click', () => {
                clearTimeout(timerId);
                dismissNotification();
            });
        }
        window.showNotification = showGlobalNotification; 

        // --- Patrimonio Page Script ---
        function initPatrimonioPage() {
            const database = databasePatrimonio;
            const { ref, get, set, update, push, remove, onValue, child } = window.firebaseDbFunctions;
            const patrimonioView = document.getElementById('page-patrimonio');
            const LOCAL_STORAGE_KEY_META = 'patrimonioMetaCosmosV4FirebaseUnified';
            const patrimonioRef = ref(database, 'patrimonioEstelar/registros');
            const metaDbRef = ref(database, 'patrimonioEstelar/meta');
            let dadosPatrimonio = [];
            let nextId = 1;
            let patrimonioChartInstance;
            let isEditMode = false;
            let metaPatrimonio = 50000;

            const metaValorDisplayEl = patrimonioView.querySelector('#metaValorDisplay');
            const definirMetaBtn = patrimonioView.querySelector('#definirMetaBtn');
            const progressBarMetaFillEl = patrimonioView.querySelector('#progressBarMetaFill');
            const metaProgressoDisplayEl = patrimonioView.querySelector('#metaProgressoDisplay');
            const metaRestanteDisplayEl = patrimonioView.querySelector('#metaRestanteDisplay');
            const maiorGanhoValorEl = patrimonioView.querySelector('#maiorGanhoValor');
            const maiorGanhoDataEl = patrimonioView.querySelector('#maiorGanhoData');
            const maiorPerdaValorEl = patrimonioView.querySelector('#maiorPerdaValor');
            const maiorPerdaDataEl = patrimonioView.querySelector('#maiorPerdaData');
            const selectAnoResumoEl = patrimonioView.querySelector('#selectAnoResumo');
            const selectMesResumoEl = patrimonioView.querySelector('#selectMesResumo');
            const resumoAgregadoContainerEl = patrimonioView.querySelector('#resumoAgregadoContainer');
            const addEntryBtn = patrimonioView.querySelector('#addEntryBtn');
            const toggleEditModeBtnEl = patrimonioView.querySelector('#toggleEditModeBtn');
            const saveAllBtnEl = patrimonioView.querySelector('#saveAllBtn');
            const cancelEditBtnEl = patrimonioView.querySelector('#cancelEditBtn');
            const editActionHeaderEl = patrimonioView.querySelector('.edit-action-header');
            const addEntryFormEl = patrimonioView.querySelector('#addEntryForm');
            const patrimonioBubbleUltimoValorEl = patrimonioView.querySelector('#patrimonioBubbleUltimoValor');
            const patrimonioBubbleMaiorValorEl = patrimonioView.querySelector('#patrimonioBubbleMaiorValor');
            const patrimonioBubbleDiferencaPicoEl = patrimonioView.querySelector('#patrimonioBubbleDiferencaPico');
            const patrimonioBubbleFlutuacaoRecenteEl = patrimonioView.querySelector('#patrimonioBubbleFlutuacaoRecente');
            
            const metaConquistadaOverlayEl = document.getElementById('meta-conquistada-overlay');
            const metaAntigaDisplayEl = document.getElementById('meta-antiga-display');
            const novaMetaPropostaDisplayEl = document.getElementById('nova-meta-proposta-display');
            const aceitarNovaMetaBtnEl = document.getElementById('aceitar-nova-meta-btn');
            const fecharMetaModalBtnEl = document.getElementById('fechar-meta-modal-btn');
            
            // ✨ Elementos da barra de progresso vertical
            const verticalProgressBarFillEl = document.getElementById('verticalProgressBarFill');
            const verticalProgressPercentageEl = document.getElementById('verticalProgressPercentage');

            function fecharModalCelebracao() {
                if (metaConquistadaOverlayEl) metaConquistadaOverlayEl.classList.remove('visible');
            }

            function dispararCelebracaoMetaAtingida(metaAtual, novaMetaProposta) {
                if (!metaConquistadaOverlayEl) return;

                metaAntigaDisplayEl.textContent = formatarMoeda(metaAtual);
                novaMetaPropostaDisplayEl.textContent = formatarMoeda(novaMetaProposta);

                metaConquistadaOverlayEl.classList.add('visible');

                const duration = 5 * 1000;
                const animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 4000 };

                function randomInRange(min, max) {
                    return Math.random() * (max - min) + min;
                }

                const interval = setInterval(function() {
                    const timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) {
                        return clearInterval(interval);
                    }
                    const particleCount = 50 * (timeLeft / duration);
                    confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                    confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
                }, 250);

                aceitarNovaMetaBtnEl.addEventListener('click', function handleAceitar() {
                    salvarMetaNoFirebase(novaMetaProposta);
                    fecharModalCelebracao();
                }, { once: true });
                
                fecharMetaModalBtnEl.addEventListener('click', function handleFechar() {
                    fecharModalCelebracao();
                }, { once: true });
            }

            function formatarDataParaEixoX(dISO) { if (!dISO) return null; return new Date(dISO + 'T00:00:00Z').getTime(); }
            function formatarDataCompletaParaExibicao(dISO) {
                if (!dISO) return "-";
                try {
                    const dateObj = new Date(dISO + 'T00:00:00Z');
                    if (isNaN(dateObj.getTime())) return "Data Inválida";
                    return dateObj.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                } catch (e) { return "Data Inválida"; }
            }
            function formatarMoeda(v) {
                if (typeof v !== 'number') { v = parseFloat(v); }
                if (isNaN(v)) { return 'R$ 0,00'; }
                return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            function calcularVariacaoDiaria(atual, anterior) { if (!anterior || anterior.patrimonio === undefined) return ""; if (atual.patrimonio > anterior.patrimonio) return "↑ Positivo"; if (atual.patrimonio < anterior.patrimonio) return "↓ Negativo"; return "Neutro"; }

            async function carregarMetaDoFirebase() {
                try {
                    const snapshot = await get(metaDbRef);
                    if (snapshot.exists() && typeof snapshot.val() === 'number') {
                        metaPatrimonio = snapshot.val();
                    } else {
                        metaPatrimonio = parseFloat(localStorage.getItem(LOCAL_STORAGE_KEY_META)) || 50000;
                        await set(metaDbRef, metaPatrimonio);
                    }
                } catch (error) {
                    console.error("Erro ao carregar meta do Firebase (Patrimônio):", error);
                    showGlobalNotification("Falha ao carregar meta da base estelar. Usando valor local.", "warning");
                    metaPatrimonio = parseFloat(localStorage.getItem(LOCAL_STORAGE_KEY_META)) || 50000;
                }
                atualizarDisplayMeta();
                atualizarGraficoPatrimonio();
            }
            async function salvarMetaNoFirebase(novaMeta) {
                try {
                    await set(metaDbRef, novaMeta);
                    metaPatrimonio = novaMeta;
                    localStorage.setItem(LOCAL_STORAGE_KEY_META, novaMeta.toString());
                    atualizarDisplayMeta();
                    atualizarGraficoPatrimonio();
                    showGlobalNotification("Nova meta salva com sucesso na base estelar!", "success");
                } catch (error) {
                    console.error("Erro ao salvar meta no Firebase (Patrimônio):", error);
                    showGlobalNotification("Falha ao salvar nova meta na base estelar.", "error");
                }
            }
            if (definirMetaBtn) definirMetaBtn.addEventListener('click', () => {
                const novoValorMetaStr = prompt("Defina sua nova meta de patrimônio galáctico:", metaPatrimonio > 0 ? metaPatrimonio.toString().replace('.',',') : "100000");
                if (novoValorMetaStr !== null) {
                    const novoValorMeta = parseFloat(novoValorMetaStr.replace(/\./g, '').replace(',', '.'));
                    if (!isNaN(novoValorMeta) && novoValorMeta >= 0) {
                        salvarMetaNoFirebase(novoValorMeta);
                    } else {
                        showGlobalNotification("Valor da meta inválido. Por favor, insira um número válido.", "warning");
                    }
                }
            });
            if (toggleEditModeBtnEl) toggleEditModeBtnEl.addEventListener('click', () => {
                isEditMode = true;
                toggleEditModeBtnEl.classList.add('hidden');
                saveAllBtnEl.classList.remove('hidden');
                cancelEditBtnEl.classList.remove('hidden');
                if(editActionHeaderEl) editActionHeaderEl.classList.remove('hidden');
                addEntryFormEl.classList.add('hidden');
                renderizarTabelaPatrimonio();
                showGlobalNotification("Interface de Edição Ativada. Modifique os registros e clique em 'Confirmar Dados'.", "info");
            });
            if (cancelEditBtnEl) cancelEditBtnEl.addEventListener('click', async () => {
                isEditMode = false;
                toggleEditModeBtnEl.classList.remove('hidden');
                saveAllBtnEl.classList.add('hidden');
                cancelEditBtnEl.classList.add('hidden');
                if(editActionHeaderEl) editActionHeaderEl.classList.add('hidden');
                addEntryFormEl.classList.remove('hidden');
                await onValue(patrimonioRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const dadosDoFirebase = snapshot.val();
                        dadosPatrimonio = Object.keys(dadosDoFirebase).map(key => ({ firebaseId: key, ...dadosDoFirebase[key] }));
                        nextId = dadosPatrimonio.length > 0 ? (Math.max(0, ...dadosPatrimonio.map(d => d.id || 0)) + 1) : 1;
                    } else {
                        dadosPatrimonio = []; nextId = 1;
                    }
                    renderizarTabelaPatrimonio();
                }, { onlyOnce: true });
                showGlobalNotification("Edição cancelada. Alterações não salvas foram descartadas.", "info");
            });
            if (saveAllBtnEl) saveAllBtnEl.addEventListener('click', async () => {
                showGlobalLoading();
                const tabelaBody = patrimonioView.querySelector('#tabelaPatrimonioBody');
                const inputsParaSalvar = [];
                let valid = true;

                tabelaBody.querySelectorAll('tr.editing-row').forEach(row => {
                    const firebaseId = row.dataset.firebaseId;
                    const idLocal = parseInt(row.dataset.id);
                    const dataInput = row.cells[0].querySelector('input');
                    const comentarioInput = row.cells[1].querySelector('input');
                    const patrimonioInput = row.cells[2].querySelector('input');

                    if (!dataInput || !comentarioInput || !patrimonioInput) return;

                    const data = dataInput.value;
                    const comentario = comentarioInput.value.trim();
                    const patrimonio = parseFloat(patrimonioInput.value);

                    if (!data || data.length !== 10 || comentario === '' || isNaN(patrimonio)) {
                        valid = false;
                        [dataInput, comentarioInput, patrimonioInput].forEach(inp => inp.style.borderColor = 'var(--cosmos-negative)');
                    } else {
                        [dataInput, comentarioInput, patrimonioInput].forEach(inp => inp.style.borderColor = '');
                        inputsParaSalvar.push({ firebaseId, idLocal, data, comentario, patrimonio });
                    }
                });

                if (!valid) {
                    showGlobalNotification("Corrija os campos com erro (borda vermelha) antes de salvar.", "warning");
                    hideGlobalLoading();
                    return;
                }

                const promessasDeAtualizacao = [];
                const idsVisuaisFirebase = new Set(inputsParaSalvar.map(item => item.firebaseId));
                const dadosPatrimonioAtuais = [...dadosPatrimonio];

                dadosPatrimonioAtuais.forEach(itemOriginal => {
                    if (itemOriginal.firebaseId && !idsVisuaisFirebase.has(itemOriginal.firebaseId)) {
                        promessasDeAtualizacao.push(excluirEntradaDoFirebasePatrimonio(itemOriginal.firebaseId));
                    }
                });

                inputsParaSalvar.forEach(itemEditado => {
                    const itemOriginal = dadosPatrimonioAtuais.find(d => d.firebaseId === itemEditado.firebaseId);
                    if (itemOriginal) {
                        const dadosParaFirebase = {
                            data: itemEditado.data,
                            comentario: itemEditado.comentario,
                            patrimonio: itemEditado.patrimonio,
                            id: itemOriginal.id
                        };
                        if (itemOriginal.data !== dadosParaFirebase.data ||
                            itemOriginal.comentario !== dadosParaFirebase.comentario ||
                            itemOriginal.patrimonio !== dadosParaFirebase.patrimonio) {
                            promessasDeAtualizacao.push(atualizarEntradaNoFirebasePatrimonio(itemEditado.firebaseId, dadosParaFirebase));
                        }
                    }
                });

                try {
                    await Promise.all(promessasDeAtualizacao);
                    showGlobalNotification("Transmissão de dados confirmada e processada no Firebase!", "success");
                } catch (error) {
                    console.error("Erro ao salvar todas as alterações no Firebase (Patrimônio):", error);
                    showGlobalNotification("Ocorreu um erro durante a sincronização com a base estelar.", "error");
                } finally {
                    isEditMode = false;
                    toggleEditModeBtnEl.classList.remove('hidden');
                    saveAllBtnEl.classList.add('hidden');
                    cancelEditBtnEl.classList.add('hidden');
                    if(editActionHeaderEl) editActionHeaderEl.classList.add('hidden');
                    addEntryFormEl.classList.remove('hidden');
                    hideGlobalLoading();
                }
            });
            async function adicionarEntradaNoFirebasePatrimonio(novaEntrada) {
                showGlobalLoading();
                try {
                    const entradaCompletaParaSalvar = { ...novaEntrada };
                    const novoRegistroRef = push(patrimonioRef);
                    await set(novoRegistroRef, entradaCompletaParaSalvar);
                    showGlobalNotification("Novo registro de log enviado para a base estelar!", "success");
                } catch (error) {
                    console.error("Erro ao adicionar entrada no Firebase (Patrimônio):", error);
                    showGlobalNotification("Falha ao registrar log na base estelar. Tente novamente.", "error");
                } finally {
                    hideGlobalLoading();
                }
            }
            async function atualizarEntradaNoFirebasePatrimonio(idFirebase, dadosAtualizados) {
                try {
                    const entradaRef = child(patrimonioRef, idFirebase);
                    await update(entradaRef, dadosAtualizados);
                } catch (error) {
                    console.error(`Erro ao atualizar entrada ${idFirebase} no Firebase (Patrimônio):`, error);
                    throw error;
                }
            }
            async function excluirEntradaDoFirebasePatrimonio(idFirebase) {
                try {
                    const entradaRef = child(patrimonioRef, idFirebase);
                    await remove(entradaRef);
                } catch (error){
                    console.error(`Erro ao excluir entrada ${idFirebase} no Firebase (Patrimônio):`, error);
                    throw error;
                }
            }
            function excluirEntradaDaLinhaNaEdicaoPatrimonio(idLocal) {
                if (!isEditMode) return;
                const row = patrimonioView.querySelector(`#tabelaPatrimonioBody tr[data-id='${idLocal}']`);
                if (row) {
                    row.remove();
                    showGlobalNotification("Registro ejetado da interface. Salve para confirmar a exclusão.", "info", 3000);
                } else {
                    console.warn(`Não foi possível encontrar la linha para excluir com ID local: ${idLocal}`);
                }
            }

            function atualizarPatrimonioInfoBubble() {
                if (!patrimonioBubbleUltimoValorEl || !patrimonioBubbleMaiorValorEl || !patrimonioBubbleDiferencaPicoEl || !patrimonioBubbleFlutuacaoRecenteEl) {
                    return;
                }

                if (dadosPatrimonio.length === 0) {
                    patrimonioBubbleUltimoValorEl.textContent = 'R$ 0,00';
                    patrimonioBubbleMaiorValorEl.textContent = 'R$ 0,00';
                    patrimonioBubbleDiferencaPicoEl.textContent = 'R$ 0,00';
                    patrimonioBubbleDiferencaPicoEl.style.color = 'var(--cosmos-text-secondary)';
                    patrimonioBubbleFlutuacaoRecenteEl.textContent = 'R$ 0,00';
                    patrimonioBubbleFlutuacaoRecenteEl.className = '';
                    patrimonioBubbleFlutuacaoRecenteEl.classList.add('neutro');
                    return;
                }

                const dadosOrdenados = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));

                const ultimoRegistro = dadosOrdenados[dadosOrdenados.length - 1];
                const ultimoValor = ultimoRegistro ? ultimoRegistro.patrimonio : 0;
                patrimonioBubbleUltimoValorEl.textContent = formatarMoeda(ultimoValor);

                const maiorRegistro = [...dadosPatrimonio].sort((a, b) => b.patrimonio - a.patrimonio)[0];
                const maiorValor = maiorRegistro ? maiorRegistro.patrimonio : 0;
                patrimonioBubbleMaiorValorEl.textContent = formatarMoeda(maiorValor);

                const diferencaPico = maiorValor - ultimoValor;
                patrimonioBubbleDiferencaPicoEl.style.color = '';

                if (ultimoValor < maiorValor) {
                    patrimonioBubbleDiferencaPicoEl.innerHTML = `-${formatarMoeda(Math.abs(diferencaPico))}`;
                    patrimonioBubbleDiferencaPicoEl.style.color = 'var(--cosmos-negative)';
                } else if (ultimoValor > maiorValor && diferencaPico !== 0) {
                    patrimonioBubbleDiferencaPicoEl.innerHTML = `Novo Pico!`;
                    patrimonioBubbleDiferencaPicoEl.style.color = 'var(--cosmos-positive)';
                } else {
                    patrimonioBubbleDiferencaPicoEl.textContent = 'No Pico!';
                    patrimonioBubbleDiferencaPicoEl.style.color = 'var(--cosmos-cyan-accent)';
                }

                let flutuacaoRecente = 0;
                patrimonioBubbleFlutuacaoRecenteEl.className = '';

                if (dadosOrdenados.length >= 2) {
                    const penultimoRegistro = dadosOrdenados[dadosOrdenados.length - 2];
                    flutuacaoRecente = ultimoValor - (penultimoRegistro ? penultimoRegistro.patrimonio : 0);
                } else if (dadosOrdenados.length === 1) {
                    flutuacaoRecente = ultimoValor;
                }

                if (flutuacaoRecente > 0) {
                    patrimonioBubbleFlutuacaoRecenteEl.textContent = `+${formatarMoeda(flutuacaoRecente)}`;
                    patrimonioBubbleFlutuacaoRecenteEl.classList.add('positivo');
                } else if (flutuacaoRecente < 0) {
                    patrimonioBubbleFlutuacaoRecenteEl.textContent = `${formatarMoeda(flutuacaoRecente)}`;
                    patrimonioBubbleFlutuacaoRecenteEl.classList.add('negativo');
                } else {
                    patrimonioBubbleFlutuacaoRecenteEl.textContent = formatarMoeda(0);
                    patrimonioBubbleFlutuacaoRecenteEl.classList.add('neutro');
                }
            }

            function renderizarTabelaPatrimonio() {
                const tabelaBody = patrimonioView.querySelector('#tabelaPatrimonioBody');
                if (!tabelaBody) return;
                tabelaBody.innerHTML = '';

                const dadosOrdenados = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));

                dadosOrdenados.forEach((item, index) => {
                    const itemAnterior = index > 0 ? dadosOrdenados[index - 1] : null;
                    const variacao = calcularVariacaoDiaria(item, itemAnterior);
                    const row = tabelaBody.insertRow();

                    row.dataset.id = item.id;
                    if(item.firebaseId) row.dataset.firebaseId = item.firebaseId;

                    if (isEditMode && item.firebaseId) {
                        row.classList.add('editing-row');
                        row.insertCell().innerHTML = `<input type="date" value="${item.data}">`;
                        row.insertCell().innerHTML = `<input type="text" value="${item.comentario}">`;
                        row.insertCell().innerHTML = `<input type="number" step="0.01" value="${item.patrimonio}">`;
                        const cellVariacaoEdit = row.insertCell();
                        cellVariacaoEdit.textContent = variacao;
                        cellVariacaoEdit.className = '';
                        if (variacao.includes("Positivo")) cellVariacaoEdit.classList.add('positivo');
                        else if (variacao.includes("Negativo")) cellVariacaoEdit.classList.add('negativo');

                        const deleteCell = row.insertCell();
                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'row-delete-btn';
                        deleteButton.onclick = () => excluirEntradaDaLinhaNaEdicaoPatrimonio(item.id);
                        deleteCell.appendChild(deleteButton);
                    } else {
                        row.classList.remove('editing-row');
                        row.insertCell().textContent = formatarDataCompletaParaExibicao(item.data);
                        row.insertCell().textContent = item.comentario;
                        row.insertCell().textContent = formatarMoeda(item.patrimonio);
                        const cellVariacao = row.insertCell();
                        cellVariacao.textContent = variacao;
                        cellVariacao.className = '';
                        if (variacao.includes("Positivo")) cellVariacao.classList.add('positivo');
                        else if (variacao.includes("Negativo")) cellVariacao.classList.add('negativo');
                        if (editActionHeaderEl && !editActionHeaderEl.classList.contains('hidden')) {
                            row.insertCell();
                        }
                    }
                });
                atualizarCardsResumoPatrimonio();
                atualizarGraficoPatrimonio();
                popularFiltrosResumoPatrimonio();
                renderizarResumoAgregadoPatrimonio();
                atualizarPatrimonioInfoBubble();
            }

            if (addEntryBtn) addEntryBtn.addEventListener('click', () => {
                showGlobalLoading();
                setTimeout(async () => {
                    const dataInput = patrimonioView.querySelector('#newEntryDate');
                    const comentarioInput = patrimonioView.querySelector('#newEntryComentario');
                    const patrimonioInput = patrimonioView.querySelector('#newEntryPatrimonio');
                    const data = dataInput.value;
                    const comentario = comentarioInput.value.trim();
                    const patrimonio = parseFloat(patrimonioInput.value);
                    if (!data || data.length !== 10 || comentario === '' || isNaN(patrimonio)) {
                        showGlobalNotification("Preencha todos os campos do log corretamente (Data: AAAA-MM-DD).", "warning");
                        hideGlobalLoading();
                        return;
                    }

                    const novaEntradaObjeto = {
                        id: nextId++,
                        data,
                        comentario,
                        patrimonio
                    };

                    dataInput.value = ''; comentarioInput.value = ''; patrimonioInput.value = '';
                    await adicionarEntradaNoFirebasePatrimonio(novaEntradaObjeto);
                }, 200);
            });

            function atualizarDisplayMeta() {
                if (!metaValorDisplayEl || !progressBarMetaFillEl || !metaProgressoDisplayEl || !metaRestanteDisplayEl) return;
                
                metaValorDisplayEl.textContent = formatarMoeda(metaPatrimonio);

                if (metaPatrimonio > 0 && dadosPatrimonio.length > 0) {
                    const dadosOrdenados = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                    const patrimonioAtual = dadosOrdenados.length > 0 ? dadosOrdenados[dadosOrdenados.length - 1].patrimonio : 0;
                    const progresso = Math.min(100, (patrimonioAtual / metaPatrimonio) * 100);
                    const restante = Math.max(0, metaPatrimonio - patrimonioAtual);

                    progressBarMetaFillEl.style.width = `${progresso.toFixed(2)}%`;
                    metaProgressoDisplayEl.textContent = `${progresso.toFixed(2)}%`;
                    metaRestanteDisplayEl.textContent = `${formatarMoeda(restante)} restantes`;
                    
                    if (verticalProgressBarFillEl) verticalProgressBarFillEl.style.height = `${progresso.toFixed(2)}%`;
                    if (verticalProgressPercentageEl) verticalProgressPercentageEl.textContent = `${progresso.toFixed(0)}%`;

                    if (progresso >= 100) {
                        const gradienteVencedorHorizontal = `linear-gradient(90deg, var(--cosmos-positive), var(--cosmos-cyan-accent), #FFD700, var(--cosmos-pink-accent))`;
                        const gradienteVencedorVertical = `linear-gradient(0deg, var(--cosmos-positive), var(--cosmos-cyan-accent), #FFD700, var(--cosmos-pink-accent))`;
                        
                        progressBarMetaFillEl.style.backgroundImage = gradienteVencedorHorizontal;
                        if (verticalProgressBarFillEl) verticalProgressBarFillEl.style.backgroundImage = gradienteVencedorVertical;
                        
                        const metaJaAtingidaKey = `metaCosmosAtingida_${metaPatrimonio}`;
                        if (!localStorage.getItem(metaJaAtingidaKey)) {
                            localStorage.setItem(metaJaAtingidaKey, 'true'); 
                            const novaMetaProposta = metaPatrimonio + 1000;
                            setTimeout(() => {
                                dispararCelebracaoMetaAtingida(metaPatrimonio, novaMetaProposta);
                            }, 1000); 
                        }
                    } else {
                        const gradientePadraoHorizontal = `linear-gradient(90deg, var(--cosmos-positive), var(--cosmos-cyan-accent))`;
                        const gradientePadraoVertical = `linear-gradient(0deg, var(--cosmos-positive), var(--cosmos-cyan-accent))`;

                        progressBarMetaFillEl.style.backgroundImage = gradientePadraoHorizontal;
                        if (verticalProgressBarFillEl) verticalProgressBarFillEl.style.backgroundImage = gradientePadraoVertical;
                    }
                } else {
                    progressBarMetaFillEl.style.width = '0%';
                    metaProgressoDisplayEl.textContent = '0%';
                    metaRestanteDisplayEl.textContent = `${formatarMoeda(metaPatrimonio)} restantes`;
                    progressBarMetaFillEl.style.backgroundImage = `linear-gradient(90deg, var(--cosmos-positive), var(--cosmos-cyan-accent))`;
                    
                    if (verticalProgressBarFillEl) verticalProgressBarFillEl.style.height = '0%';
                    if (verticalProgressPercentageEl) verticalProgressPercentageEl.textContent = '0%';
                }
            }

            function calcularMaiorVariacaoDiariaPatrimonio() {
                if (!maiorGanhoValorEl || !maiorGanhoDataEl || !maiorPerdaValorEl || !maiorPerdaDataEl) return;
                if (dadosPatrimonio.length < 2) {
                    maiorGanhoValorEl.textContent = formatarMoeda(0); maiorGanhoDataEl.textContent = "-";
                    maiorPerdaValorEl.innerHTML = `<span class="">${formatarMoeda(0)}</span>`; maiorPerdaDataEl.textContent = "-";
                    return;
                }
                let maiorGanho = 0; let dataMaiorGanho = "-"; let maiorPerda = 0; let dataMaiorPerda = "-";
                const dadosOrdenados = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                for (let i = 1; i < dadosOrdenados.length; i++) {
                    const variacao = dadosOrdenados[i].patrimonio - dadosOrdenados[i-1].patrimonio;
                    if (variacao > maiorGanho) { maiorGanho = variacao; dataMaiorGanho = formatarDataCompletaParaExibicao(dadosOrdenados[i].data); }
                    if (variacao < maiorPerda) { maiorPerda = variacao; dataMaiorPerda = formatarDataCompletaParaExibicao(dadosOrdenados[i].data); }
                }
                maiorGanhoValorEl.textContent = formatarMoeda(maiorGanho); maiorGanhoDataEl.textContent = dataMaiorGanho;
                maiorPerdaValorEl.innerHTML = `<span class="${maiorPerda < 0 ? 'negativo' : ''}">${formatarMoeda(Math.abs(maiorPerda))}</span>`;
                maiorPerdaDataEl.textContent = dataMaiorPerda;
            }
            function popularFiltrosResumoPatrimonio() {
                if (!selectAnoResumoEl || !selectMesResumoEl) return;
                const anos = [...new Set(dadosPatrimonio.map(d => d.data.substring(0, 4)))].sort((a,b) => b-a);
                const anoSelecionadoAntes = selectAnoResumoEl.value;
                selectAnoResumoEl.innerHTML = '<option value="">Selecione o Ano</option>';
                anos.forEach(ano => { const option = document.createElement('option'); option.value = ano; option.textContent = ano; selectAnoResumoEl.appendChild(option); });
                if(anos.includes(anoSelecionadoAntes)) selectAnoResumoEl.value = anoSelecionadoAntes;

                const mesesNomes = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                const mesSelecionadoAntes = selectMesResumoEl.value;
                selectMesResumoEl.innerHTML = '<option value="todos">Todos os Meses</option>';
                mesesNomes.forEach((nome, index) => { const option = document.createElement('option'); option.value = String(index + 1).padStart(2, '0'); option.textContent = nome; selectMesResumoEl.appendChild(option); });
                if (mesSelecionadoAntes && selectMesResumoEl.querySelector(`option[value="${mesSelecionadoAntes}"]`)) {
                    selectMesResumoEl.value = mesSelecionadoAntes;
                } else {
                    selectMesResumoEl.value = "todos";
                }

                if (!selectAnoResumoEl.dataset.listenerAttachedPatrimonio) {
                    selectAnoResumoEl.addEventListener('change', renderizarResumoAgregadoPatrimonio);
                    selectAnoResumoEl.dataset.listenerAttachedPatrimonio = 'true';
                }
                if (!selectMesResumoEl.dataset.listenerAttachedPatrimonio) {
                    selectMesResumoEl.addEventListener('change', renderizarResumoAgregadoPatrimonio);
                    selectMesResumoEl.dataset.listenerAttachedPatrimonio = 'true';
                }
            }
            function renderizarResumoAgregadoPatrimonio() {
                if (!resumoAgregadoContainerEl || !selectAnoResumoEl || !selectMesResumoEl) return;
                const anoSelecionado = selectAnoResumoEl.value;
                const mesSelecionado = selectMesResumoEl.value;
                resumoAgregadoContainerEl.innerHTML = '';
                if (!anoSelecionado) { resumoAgregadoContainerEl.innerHTML = '<p class="placeholder-resumo">Selecione um ano para análise.</p>'; return; }

                let dadosFiltrados = dadosPatrimonio.filter(d => d.data.startsWith(anoSelecionado));
                if (mesSelecionado !== "todos") { dadosFiltrados = dadosFiltrados.filter(d => d.data.startsWith(`${anoSelecionado}-${mesSelecionado}`)); }
                if (dadosFiltrados.length === 0) { resumoAgregadoContainerEl.innerHTML = '<p class="placeholder-resumo">Nenhum registro para este período.</p>'; return; }

                dadosFiltrados.sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                const patrimonioInicialPeriodo = dadosFiltrados[0].patrimonio;
                const patrimonioFinalPeriodo = dadosFiltrados[dadosFiltrados.length - 1].patrimonio;
                const variacaoTotal = patrimonioFinalPeriodo - patrimonioInicialPeriodo;
                const variacaoPercentual = patrimonioInicialPeriodo !== 0 ? (variacaoTotal / Math.abs(patrimonioInicialPeriodo)) * 100 : (variacaoTotal !== 0 ? (variacaoTotal > 0 ? Infinity : -Infinity) : 0);

                const divResumo = document.createElement('div'); divResumo.classList.add('resumo-item');
                let tituloPeriodo = `Ano de ${anoSelecionado}`;
                if (mesSelecionado !== "todos") { const nomeMes = selectMesResumoEl.options[selectMesResumoEl.selectedIndex]?.text || `Mês ${mesSelecionado}`; tituloPeriodo = `${nomeMes} de ${anoSelecionado}`; }
                divResumo.innerHTML = `
                    <h4>Resumo: ${tituloPeriodo}</h4>
                    <p>Patrimônio Inicial: <strong>${formatarMoeda(patrimonioInicialPeriodo)}</strong></p>
                    <p>Patrimônio Final: <strong>${formatarMoeda(patrimonioFinalPeriodo)}</strong></p>
                    <p>Variação no Período: <strong class="${variacaoTotal >= 0 ? 'positivo' : 'negativo'}">${formatarMoeda(variacaoTotal)}</strong></p>
                    <p>Variação Percentual: <strong class="${variacaoTotal >= 0 ? 'positivo' : 'negativo'}">${isFinite(variacaoPercentual) ? variacaoPercentual.toFixed(2) + '%' : (variacaoTotal > 0 ? '∞%' : '-∞%')}</strong></p>
                `;
                resumoAgregadoContainerEl.appendChild(divResumo);
            }
            function calcularCrescimentoMensalPatrimonio(anoMesFiltro, spanId) {
                const spanElement = patrimonioView.querySelector(`#${spanId}`);
                if (!spanElement) { return; }
                const entradasDoMesAtual = dadosPatrimonio.filter(item => item.data.startsWith(anoMesFiltro)).sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                let crescimento = 0;
                if (entradasDoMesAtual.length > 0) {
                    const ultimoPatrimonioDoMesAtual = entradasDoMesAtual[entradasDoMesAtual.length - 1].patrimonio;
                    const [ano, mes] = anoMesFiltro.split('-').map(Number);
                    let anoAnterior = ano; let mesAnteriorNum = mes - 1;
                    if (mesAnteriorNum === 0) { mesAnteriorNum = 12; anoAnterior--; }
                    const mesAnteriorFiltro = `${anoAnterior}-${String(mesAnteriorNum).padStart(2, '0')}`;
                    const entradasDoMesAnterior = dadosPatrimonio.filter(item => item.data.startsWith(mesAnteriorFiltro)).sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                    const ultimoPatrimonioMesAnterior = entradasDoMesAnterior.length > 0 ? entradasDoMesAnterior[entradasDoMesAnterior.length - 1].patrimonio : 0;

                    if (entradasDoMesAnterior.length === 0) {
                        const todosDadosOrdenados = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                        const ultimoRegistroAntesDoMesAtual = todosDadosOrdenados.filter(d => new Date(d.data + 'T00:00:00Z') < new Date(entradasDoMesAtual[0].data + 'T00:00:00Z')).pop();
                        if (ultimoRegistroAntesDoMesAtual) {
                            crescimento = ultimoPatrimonioDoMesAtual - ultimoRegistroAntesDoMesAtual.patrimonio;
                        } else {
                            crescimento = entradasDoMesAtual.length > 1 ? ultimoPatrimonioDoMesAtual - entradasDoMesAtual[0].patrimonio : ultimoPatrimonioDoMesAtual;
                        }
                    } else {
                        crescimento = ultimoPatrimonioDoMesAtual - ultimoPatrimonioMesAnterior;
                    }
                }
                spanElement.textContent = formatarMoeda(crescimento);
                spanElement.className = 'valor-card';
                if (crescimento > 0) spanElement.classList.add('positivo');
                else if (crescimento < 0) spanElement.classList.add('negativo');
            }
            function atualizarCardsResumoPatrimonio() {
                const sDV = patrimonioView.querySelector('#diaMaisForteValor');
                const sDD = patrimonioView.querySelector('#diaMaisForteData');
                if (dadosPatrimonio.length === 0) {
                    if(sDV) sDV.textContent = formatarMoeda(0);
                    if(sDD) sDD.textContent = "-";
                } else {
                    const dOV = [...dadosPatrimonio].sort((a, b) => b.patrimonio - a.patrimonio || new Date(b.data + 'T00:00:00Z') - new Date(a.data + 'T00:00:00Z'));
                    const mPI = dOV[0];
                    if(sDV && mPI) sDV.textContent = formatarMoeda(mPI.patrimonio); else if(sDV) sDV.textContent = formatarMoeda(0);
                    if(sDD && mPI) sDD.textContent = formatarDataCompletaParaExibicao(mPI.data); else if(sDD) sDD.textContent = "-";
                }
                calcularCrescimentoMensalPatrimonio("2025-03", "crescimentoMarco");
                calcularCrescimentoMensalPatrimonio("2025-04", "crescimentoAbril");
                atualizarDisplayMeta();
                calcularMaiorVariacaoDiariaPatrimonio();
            }
            function atualizarGraficoPatrimonio() {
                const dO = [...dadosPatrimonio].sort((a, b) => new Date(a.data + 'T00:00:00Z') - new Date(b.data + 'T00:00:00Z'));
                const chartDataPoints = dO.map(item => ({ x: formatarDataParaEixoX(item.data), y: item.patrimonio }));
                const cS = getComputedStyle(document.body);
                const primaryChartColor = cS.getPropertyValue('--cosmos-cyan-accent').trim() || '#6AF2F0';
                const gridColor = cS.getPropertyValue('--cosmos-input-border').trim() || 'rgba(124, 58, 237, 0.2)';
                const textColor = cS.getPropertyValue('--cosmos-text-secondary').trim() || '#A0AEC0';
                const legendColor = cS.getPropertyValue('--cosmos-text-primary').trim() || '#E0E0E0';
                const warningColor = cS.getPropertyValue('--cosmos-warning').trim() || '#FBBF24';

                const datasets = [{
                    label: 'Patrimônio (UM)', data: chartDataPoints, borderColor: primaryChartColor,
                    backgroundColor: primaryChartColor + '26', tension: 0.3, fill: true,
                    pointBackgroundColor: primaryChartColor, pointBorderColor: 'var(--cosmos-bg)',
                    pointHoverBackgroundColor: 'var(--cosmos-bg)', pointHoverBorderColor: primaryChartColor,
                    pointRadius: 4, pointHoverRadius: 7, order: 1,
                    segment: {
                        borderColor: ctx => {
                            if (!ctx.p0 || !ctx.p1) return primaryChartColor;
                            return ctx.p1.parsed.y < ctx.p0.parsed.y ? 'var(--cosmos-negative)' : primaryChartColor;
                        }
                    }
                }];

                if (metaPatrimonio > 0) {
                    datasets.push({
                        label: 'Meta Galáctica',
                        data: chartDataPoints.map(p => ({ x: p.x, y: metaPatrimonio })),
                        borderColor: warningColor, borderWidth: 2, borderDash: [5, 5],
                        pointRadius: 0, fill: false, tension: 0, order: 0
                    });
                }

                const opt = {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            adapters: { date: { locale: window.dateFns?.locale?.ptBR } },
                            time: { unit: 'month', tooltipFormat: 'dd/MM/yyyy', displayFormats: { month: 'MMM/yy', day: 'dd/MM' } },
                            ticks: { color: textColor, font: { family: 'var(--font-body)' }, source: 'auto', maxRotation: 45, minRotation: 30, autoSkip: true, autoSkipPadding: 20 },
                            grid: { color: gridColor, borderColor: gridColor }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: { callback: function(v) { return formatarMoeda(v); }, color: textColor, font: { family: 'var(--font-body)' } },
                            grid: { color: gridColor, borderColor: gridColor }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { color: legendColor, font: { family: 'var(--font-title)' } } },
                        tooltip: {
                            backgroundColor: 'rgba(13,17,23,0.9)', titleFont: { family: 'var(--font-title)'}, bodyFont: { family: 'var(--font-body)'},
                            titleColor: primaryChartColor, bodyColor: legendColor, borderColor: primaryChartColor, borderWidth:1,
                            callbacks: {
                                title: function(tooltipItems) {
                                    if (tooltipItems.length > 0 && tooltipItems[0].parsed) {
                                        const date = new Date(tooltipItems[0].parsed.x);
                                        return window.dateFns && window.dateFns.format ? window.dateFns.format(date, 'dd/MM/yyyy', { locale: window.dateFns.locale?.ptBR }) : date.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                                    } return '';
                                },
                                label: function(ctx) { let l = ctx.dataset.label || ''; if (l) l += ': '; if (ctx.parsed?.y !== null && ctx.parsed?.y !== undefined) l += formatarMoeda(ctx.parsed.y); return l; }
                            }
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                };

                if (patrimonioChartInstance) {
                    patrimonioChartInstance.data.datasets = datasets;
                    patrimonioChartInstance.options = opt;
                    patrimonioChartInstance.update('none');
                } else {
                    const ctx = patrimonioView.querySelector('#patrimonioChart')?.getContext('2d');
                    if (!ctx) { console.error("Contexto do canvas #patrimonioChart não encontrado!"); return; }
                    patrimonioChartInstance = new Chart(ctx, { type: 'line', data: { datasets: datasets }, options: opt });
                }
            }
        
            showGlobalLoading();
            carregarMetaDoFirebase();
            onValue(patrimonioRef, (snapshot) => {
                console.log("Dados de registros (Patrimônio) recebidos do Firebase.");
                if (snapshot.exists()) {
                    const dadosDoFirebase = snapshot.val();
                    dadosPatrimonio = Object.keys(dadosDoFirebase).map(key => ({
                        firebaseId: key,
                        ...dadosDoFirebase[key],
                        id: dadosDoFirebase[key].id || key
                    }));
                    nextId = dadosPatrimonio.length > 0 ? (Math.max(0, ...dadosPatrimonio.map(d => parseInt(d.id) || 0)) + 1) : 1;
                } else {
                    dadosPatrimonio = [];
                    nextId = 1;
                }
                renderizarTabelaPatrimonio();
                hideGlobalLoading();
            }, (error) => {
                console.error("Erro ao escutar dados de registros do Firebase (Patrimônio):", error);
                showGlobalNotification("Falha na conexão em tempo real com a base de registros estelar.", "error");
                if (patrimonioBubbleUltimoValorEl) patrimonioBubbleUltimoValorEl.textContent = 'Erro Conexão';
                hideGlobalLoading();
            });
        }

        // --- Initialize the default page on load ---
        document.addEventListener('DOMContentLoaded', () => {
            initPatrimonioPage(); 
        });

    </script>

    <script>
        // This remains for PWA functionality if you have a service-worker.js file.
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('Service Worker registrado!', reg))
                .catch(err => console.error('Erro no Service Worker:', err));
            });
        }
    </script>
</body>
</html>